---
import Layout from '../layouts/Layout.astro';
import ChatwootWidget from '../components/ChatwootWidget.astro';
---

<Layout title="Debug Chatwoot Widget">
  <main style="padding: 2rem;">
    <h1>üîß Chatwoot Widget Debug</h1>
    
    <div style="margin: 2rem 0;">
      <h2>Test URLs:</h2>
      <ul>
        <li><a href="/demo">Demo Hotel (/demo)</a></li>
        <li><a href="/baberrih">Baberrih Hotel (/baberrih)</a></li>
        <li><a href="/debug-chatwoot">This page (no hotel context)</a></li>
      </ul>
    </div>

    <div style="margin: 2rem 0;">
      <h2>Expected Behavior:</h2>
      <ul>
        <li>‚úÖ Widget should appear in bottom-right corner</li>
        <li>‚úÖ Console should show: "‚úÖ ChatwootWidget loaded for: [Hotel Name]"</li>
        <li>‚ùå If you see "‚ö†Ô∏è Chatwoot not configured" - there's an issue</li>
      </ul>
    </div>

    <div style="margin: 2rem 0;">
      <h2>Debug Info:</h2>
      <div id="debug-info" style="background: #f5f5f5; padding: 1rem; border-radius: 5px; font-family: monospace;">
        <p>Current URL: <span id="current-url"></span></p>
        <p>Path segments: <span id="path-segments"></span></p>
        <p>Detected hotel: <span id="detected-hotel"></span></p>
        <p>Target domain: <span id="target-domain"></span></p>
      </div>
    </div>

    <div style="margin: 2rem 0;">
      <h2>Console Logs:</h2>
      <div id="console-logs" style="background: #000; color: #0f0; padding: 1rem; border-radius: 5px; font-family: monospace; height: 200px; overflow-y: auto;">
        <!-- Logs will appear here -->
      </div>
    </div>
  </main>

  <script>
    // Debug info
    const currentUrl = window.location.href;
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const detectedHotel = pathSegments[0] || 'none';
    const targetDomain = detectedHotel !== 'none' ? `${detectedHotel}.daotomata.io` : 'none';

    document.getElementById('current-url').textContent = currentUrl;
    document.getElementById('path-segments').textContent = JSON.stringify(pathSegments);
    document.getElementById('detected-hotel').textContent = detectedHotel;
    document.getElementById('target-domain').textContent = targetDomain;

    // Capture console logs
    const originalLog = console.log;
    const originalError = console.error;
    const logsDiv = document.getElementById('console-logs');

    function addLog(message, type = 'log') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#f00' : '#0f0';
      logsDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addLog(args.join(' '));
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addLog(args.join(' '), 'error');
    };

    // Test Supabase connection
    addLog('üîç Testing Supabase connection...');
    
    // Check if widget loads
    setTimeout(() => {
      if (window.chatwootConfig) {
        addLog('‚úÖ Chatwoot config found: ' + JSON.stringify(window.chatwootConfig));
      } else {
        addLog('‚ùå No chatwoot config found');
      }
    }, 2000);
  </script>

  <!-- Include widget without domain to test auto-detection -->
  <ChatwootWidget />
</Layout>
