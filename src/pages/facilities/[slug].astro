---
export const prerender = true; // ‚úÖ SSG - Pre-render at build time

import { DetailPageLayout } from '../../components/DetailPageLayout.tsx';
import Layout from '../../layouts/Layout.astro';
import { getCurrentHotel, getMediaUrl, processMediaGallery } from '../../lib/directus.js';

// Generate static paths for all facilities
export async function getStaticPaths() {
  const hotel: any = await getCurrentHotel();

  if (!hotel || !hotel.facilities) {
    return [];
  }

  return hotel.facilities.map((facility: any) => ({
    params: {
      slug: facility.name?.toLowerCase().replace(/\s+/g, '-') || facility.id?.toString()
    },
  }));
}

console.log(`üèóÔ∏è [BUILD] Pre-rendering facility detail page...`);

// Get hotel data from environment variable
const hotel: any = await getCurrentHotel();

if (!hotel) {
  throw new Error('Hotel not found. Check HOTEL_ID in environment variables.');
}

const { slug } = Astro.params;

console.log(`‚úÖ [BUILD] Hotel loaded: ${hotel.name}, looking for facility: ${slug}`);

// Find the specific facility
const facility = hotel.facilities?.find((f: any) => 
  f.name?.toLowerCase().replace(/\s+/g, '-') === slug ||
  f.slug === slug ||
  f.id?.toString() === slug
);

if (!facility) {
  console.error(`‚ùå [BUILD] Facility not found: ${slug}`);
  return Astro.redirect('/404');
}

console.log(`‚úÖ [BUILD] Facility found: ${facility.name} (ID: ${facility.id})`);

// Simple theme name extraction
const hotelSlug = hotel.domain?.split('.')[0] || 'default';

// Process facility media
const mainImageUrl = facility.main_photo
  ? getMediaUrl(facility.main_photo.id || facility.main_photo, {
      width: 1200,
      height: 675,
      quality: 95,
    }) || ''
  : '';

const mainVideoUrl = facility.main_video
  ? getMediaUrl(facility.main_video.id || facility.main_video) || ''
  : '';

// Process gallery images with automatic type detection
const galleryImages = processMediaGallery(facility.media_gallery, facility.name) as Array<{
  id: string;
  url: string;
  title?: string;
  type?: "image" | "video";
}>;

// Process facility metadata
const metadata = {
  capacity: facility.capacity,
  operatingHours: facility.operating_hours,
  bookingRequired: facility.booking_requiered, // Note: typo in schema
  price: facility.price,
  amenities: facility.amenities,
  ageRestriction: facility.age_restriction,
  isAccessible: facility.is_accessible,
};

const pageTitle = `${facility.name} - ${hotel.name}`;
const pageDescription = facility.description || `Discover ${facility.name} at ${hotel.name}`;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  hotel={hotel}
  hotelName={hotel.name}
>
  <DetailPageLayout
    title={facility.name}
    description={facility.description || ''}
    type="facility"
    imageUrl={mainImageUrl}
    videoUrl={mainVideoUrl}
    galleryImages={galleryImages}
    metadata={metadata}
    hotelName={hotel.name}
    hotelSlug={hotelSlug}
    defaultCurrency={hotel.default_currency || 'EUR'}
    breadcrumbItems={[
      { label: 'Home', href: '/' },
      { label: 'Facilities', href: '/facilities' },
      { label: facility.name, href: `/facilities/${slug}` }
    ]}
  />
</Layout>
