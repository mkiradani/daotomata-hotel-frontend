---
// NO prerender = SSR por defecto âœ… Para lÃ³gica de booking

import Layout from '../layouts/Layout.astro';
import { BookingWidgetReal } from '../components/BookingWidgetReal.tsx';
import { Breadcrumb } from '../components/Breadcrumb.tsx';
import CTASection from '../components/CTASection.astro';
import { getCurrentHotel } from '../lib/directus.js';
import type { Hotel } from '../types/hotel.js';

console.log(`ðŸ”„ [SSR] Processing booking request...`);

// Get hotel data from environment variable
const hotel = (await getCurrentHotel()) as Hotel | null;

if (!hotel) {
  throw new Error('Hotel not found. Check HOTEL_ID in environment variables.');
}

console.log(`âœ… [SSR] Hotel loaded: ${hotel.name} (ID: ${hotel.id})`);

const pageTitle = `Book Your Stay - ${hotel.name}`;
const pageDescription = `Book your perfect stay at ${hotel.name}. Check availability, compare rooms, and make your reservation instantly.`;

// Get URL parameters for pre-filling the form
const url = new URL(Astro.request.url);
const checkIn = url.searchParams.get('checkin') || '';
const checkOut = url.searchParams.get('checkout') || '';
const adults = url.searchParams.get('adults') || '2';
const children = url.searchParams.get('children') || '0';
const rooms = url.searchParams.get('rooms') || '1';
const roomType = url.searchParams.get('roomType') || '';

console.log(`ðŸ”„ [SSR] Booking parameters:`, {
  checkIn,
  checkOut,
  adults,
  children,
  rooms,
  roomType,
});
---

<Layout
  title={pageTitle}
  description={pageDescription}
  hotel={hotel}
  hotelName={hotel.name}
>
  <!-- Breadcrumb Navigation -->
  <Breadcrumb
    items={[{ label: hotel.name, href: '/' }, { label: 'Book Your Stay' }]}
    client:load
  />

  <!-- Hero Section -->
  <section class="relative bg-base-200 py-16">
    <div class="mx-auto px-4 container">
      <div class="mx-auto max-w-4xl text-center">
        <h1 class="mb-6 font-primary text-primary text-4xl md:text-5xl">
          Book Your Stay
        </h1>
        <p class="mb-8 text-base-content/80 text-xl leading-relaxed">
          at {hotel.name}
        </p>
        <p class="text-base-content/70 text-lg">
          Experience luxury and comfort with our seamless booking system. Check
          real-time availability and secure your perfect room today.
        </p>
      </div>
    </div>
  </section>

  <!-- Booking Widget Section -->
  <section class="py-16">
    <div class="mx-auto px-4 container">
      <div class="mx-auto max-w-6xl">
        <BookingWidgetReal
          hotelDomain={hotel.domain}
          hotelName={hotel.name}
          defaultCurrency={hotel.default_currency || 'USD'}
          className="w-full"
          compact={false}
        />
      </div>
    </div>
  </section>

  <!-- Call to Action -->
  <CTASection
    title="Need Help with Your Booking?"
    description="Our team is here to assist you with any questions or special requests for your stay."
    primaryText="Contact Us"
    primaryHref="/contact"
    secondaryText="View Rooms"
    secondaryHref="/accommodation"
  />
</Layout>
